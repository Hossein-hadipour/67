<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø¯Ø§Ø±Ø³</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #10b981;
            --accent: #ec4899;
            --bg: #f9fafb;
            --card: #ffffff;
            --text: #111827;
            --border: #e5e7eb;
            --shadow: rgba(0,0,0,0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body { font-family: 'Vazirmatn', sans-serif; direction: rtl; text-align: right; margin: 0; padding: 0; background: var(--bg); color: var(--text); transition: var(--transition); min-height: 100vh; position: relative; overflow-x: hidden; }
        #hamburger { position: fixed; top: 24px; right: 24px; font-size: 32px; cursor: pointer; color: var(--primary); z-index: 1001; transition: var(--transition); border-radius: 50%; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; background: var(--card); box-shadow: 0 4px 16px var(--shadow); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        #hamburger:hover { transform: rotate(180deg) scale(1.1); box-shadow: 0 8px 24px var(--shadow); }
        #menu { position: fixed; top: 100px; right: 24px; background: var(--card); border-radius: 24px; box-shadow: 0 16px 48px var(--shadow); padding: 32px; display: none; z-index: 1000; min-width: 280px; border: 1px solid var(--border); transition: var(--transition); animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #menu ul { list-style: none; padding: 0; margin: 0; }
        #menu li { padding: 20px 28px; cursor: pointer; border-radius: 16px; transition: var(--transition); font-weight: 600; font-size: 18px; display: flex; align-items: center; gap: 16px; position: relative; overflow: hidden; }
        #menu li:before { content: ''; position: absolute; top: 0; right: 0; width: 0; height: 100%; background: var(--primary); transition: var(--transition); z-index: -1; }
        #menu li:hover { color: white; transform: translateX(-10px); }
        #menu li:hover:before { width: 100%; }
        .section { padding: 48px; max-width: 1520px; margin: 48px auto; background: var(--card); border-radius: 28px; box-shadow: 0 16px 48px var(--shadow); transition: var(--transition); border: 1px solid var(--border); position: relative; overflow: hidden; animation: slideUp 0.5s; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        form { display: grid; gap: 24px; }
        input, select, textarea { width: 100%; padding: 18px; box-sizing: border-box; border: 1px solid var(--border); border-radius: 16px; transition: var(--transition); font-size: 16px; background: var(--bg); box-shadow: inset 0 2px 8px var(--shadow); }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 5px rgba(59,130,246,0.2); }
        button { padding: 18px 32px; background: var(--primary); color: white; border: none; border-radius: 16px; cursor: pointer; transition: var(--transition); font-weight: 600; font-size: 18px; box-shadow: 0 8px 24px rgba(59,130,246,0.3); }
        button:hover { background: var(--primary-dark); transform: translateY(-5px); box-shadow: 0 12px 32px rgba(59,130,246,0.4); }
        .table-wrapper { overflow: auto; max-height: 650px; border: 1px solid var(--border); border-radius: 20px; box-shadow: 0 8px 24px var(--shadow); overflow-x: auto; max-width: 100%; }
        table { width: 100%; border-collapse: collapse; font-size: 15px; }
        th, td { border: 1px solid var(--border); padding: 18px; text-align: right; transition: var(--transition); }
        th { background: rgba(59,130,246,0.05); position: sticky; top: 0; z-index: 1; font-weight: 700; }
        canvas.signature { border: 2px dashed var(--border); border-radius: 20px; width: 340px; height: 190px; background: var(--bg); box-shadow: 0 4px 16px var(--shadow); }
        footer { text-align: center; padding: 28px; background: var(--card); position: fixed; bottom: 0; width: 100%; box-shadow: 0 -12px 32px var(--shadow); font-size: 16px; color: #6b7280; border-top: 1px solid var(--border); transition: var(--transition); }
        .companion { display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 18px; align-items: end; border: 1px solid var(--border); padding: 24px; border-radius: 20px; margin-bottom: 18px; background: rgba(59,130,246,0.02); box-shadow: 0 4px 16px var(--shadow); }
        #axes table { width: 100%; border-collapse: separate; border-spacing: 0 14px; }
        #axes tbody tr { background: rgba(59,130,246,0.03); border-radius: 16px; box-shadow: 0 2px 12px var(--shadow); }
        #axes td { padding: 16px; background: transparent; }
        .score-display { font-size: 28px; font-weight: 700; color: var(--primary); text-align: center; margin: 24px 0; padding: 24px; background: rgba(59,130,246,0.05); border-radius: 20px; box-shadow: 0 4px 16px var(--shadow); transition: var(--transition); }
        .score-display:hover { transform: scale(1.02); }
        #location { margin-top: 10px; color: var(--secondary); font-weight: bold; }
        #audioPlayer { margin-top: 10px; width: 100%; }
        #photoPreview { margin-top: 10px; max-width: 200px; border-radius: 8px; box-shadow: 0 2px 8px var(--shadow); }
        #map { height: 300px; width: 100%; margin-top: 10px; }
        @media (max-width: 1024px) { .section { padding: 32px; margin: 32px; } }
        @media (max-width: 768px) { .section { padding: 24px; margin: 24px; } canvas.signature { width: 100%; height: 160px; } .companion { grid-template-columns: 1fr; } }
        @media (max-width: 480px) { #hamburger { width: 56px; height: 56px; font-size: 28px; } #menu { top: 90px; right: 12px; padding: 20px; } }
    </style>
</head>
<body>
    <div id="login" style="display: block;">
        <div class="section">
            <h1 style="text-align: center; font-size: 36px; margin-bottom: 48px; color: var(--primary);">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø¯Ø§Ø±Ø³</h1>
            <form id="loginForm" style="max-width: 560px; margin: 0 auto;">
                <label style="font-size: 20px; margin-bottom: 10px; display: block;">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                <input id="username" type="text" required placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                <label style="font-size: 20px; margin-bottom: 10px; display: block; margin-top: 24px;">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                <input id="password" type="password" required placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                <button type="button" onclick="login()" style="width: 100%; margin-top: 48px; padding: 20px; font-size: 20px;">ÙˆØ±ÙˆØ¯</button>
            </form>
        </div>
    </div>
    <div id="app" style="display:none;">
        <div id="hamburger">â˜°</div>
        <nav id="menu">
            <ul>
                <li id="dashboard">ğŸ›¡ï¸ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</li>
                <li id="users">ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</li>
                <li id="formBuilder">ğŸ› ï¸ Ø³Ø§Ø²Ù†Ø¯Ù‡ ÙØ±Ù…</li>
                <li id="evaluation">ğŸ“ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</li>
                <li id="reports">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</li>
                <li id="analytics">ğŸ” ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§</li>
                <li id="ranking">ğŸ† Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ</li>
                <li id="pdf">ğŸ“„ Ø®Ø±ÙˆØ¬ÛŒ PDF</li>
                <li id="logout">ğŸšª Ø®Ø±ÙˆØ¬</li>
            </ul>
        </nav>
        <div id="dashboard-section" class="section" style="display:none;">
            <h1>ğŸ›¡ï¸ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h1>
            <p>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯! ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</p>
            <div id="stats">
                <h2>Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ…</h2>
                <p id="userCount"></p>
                <p id="evalCount"></p>
                <p id="avgScore"></p>
                <p id="statusSummary"></p>
            </div>
        </div>
        <div id="users-section" class="section" style="display:none;">
            <h1>ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h1>
            <form id="userForm">
                <input id="firstName" placeholder="Ù†Ø§Ù…" required>
                <input id="lastName" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" required>
                <input id="fatherName" placeholder="Ù†Ø§Ù… Ù¾Ø¯Ø±">
                <input id="personnelCode" placeholder="Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ (Ú©Ù„ÛŒØ¯ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯)" required>
                <input id="nationalCode" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ">
                <select id="role" required><option value="SUPER_ADMIN">Ø³ÙˆÙ¾Ø± Ø§Ø¯Ù…ÛŒÙ†</option><option value="ADMIN">Ø§Ø¯Ù…ÛŒÙ†</option><option value="EVALUATOR">Ø§Ø±Ø²ÛŒØ§Ø¨</option></select>
                <input id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" required>
                <input id="password" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required>
                <select id="status" required><option value="active">ÙØ¹Ø§Ù„</option><option value="inactive">ØºÛŒØ±ÙØ¹Ø§Ù„</option></select>
                <button type="button" onclick="saveUser()">Ø°Ø®ÛŒØ±Ù‡</button>
            </form>
            <input id="searchInputUsers" type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
            <div class="table-wrapper">
                <table id="usersTable"><thead><tr><th>Ù†Ø§Ù…</th><th>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</th><th>Ù†Ù‚Ø´</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody></tbody></table>
            </div>
            <button onclick="exportUsersToExcel()">Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
            <button onclick="exportUsersToJson()">Ø®Ø±ÙˆØ¬ÛŒ JSON Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
            <input type="file" id="importUsersJson" accept=".json" onchange="importUsersFromJson()">
            <button onclick="document.getElementById('importUsersJson').click()">ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† JSON Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
        </div>
        <div id="formBuilder-section" class="section" style="display:none;">
            <h1>ğŸ› ï¸ Ø³Ø§Ø²Ù†Ø¯Ù‡ ÙØ±Ù…</h1>
            <form id="criterionForm">
                <input id="title" placeholder="Ø¹Ù†ÙˆØ§Ù†" required>
                <input id="axis" placeholder="Ù…Ø­ÙˆØ± (Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ)" required>
                <input id="weight" type="number" placeholder="ÙˆØ²Ù†" required min="1">
                <select id="enabled" required><option value="true">ÙØ¹Ø§Ù„</option><option value="false">ØºÛŒØ±ÙØ¹Ø§Ù„</option></select>
                <button type="button" onclick="saveCriterion()">Ø°Ø®ÛŒØ±Ù‡</button>
            </form>
            <input id="searchInputCriteria" type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
            <button onclick="saveCriteriaOrder()">Ø°Ø®ÛŒØ±Ù‡ ØªØ±ØªÛŒØ¨</button>
            <div class="table-wrapper">
                <table id="criteriaTable"><thead><tr><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ù…Ø­ÙˆØ±</th><th>ÙˆØ²Ù†</th><th>ÙØ¹Ø§Ù„</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="sortableCriteria"></tbody></table>
            </div>
            <button onclick="exportCriteriaToJson()">Ø®Ø±ÙˆØ¬ÛŒ JSON Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</button>
            <input type="file" id="importCriteriaJson" accept=".json" onchange="importCriteriaFromJson()">
            <button onclick="document.getElementById('importCriteriaJson').click()">ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† JSON Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</button>
        </div>
        <div id="evaluation-section" class="section" style="display:none;">
            <h1>ğŸ“ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</h1>
            <div id="evaluationForm">
                <h2>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø¯Ø±Ø³Ù‡</h2>
                <table id="evaluationTable">
                    <tr><td>Ù†ÙˆØ¹ Ù…Ø¯ÛŒØ±ÛŒØª</td><td><select id="managementType" required><option>Ù†ÙˆØ¹ Ù…Ø¯ÛŒØ±ÛŒØª</option><option>Ø¯ÙˆÙ„ØªÛŒ</option><option>Ø®ØµÙˆØµÛŒ</option></select></td></tr>
                    <tr><td>Ù†Ø§Ù… Ù…Ø¯Ø±Ø³Ù‡</td><td><input id="schoolName" placeholder="Ù†Ø§Ù… Ù…Ø¯Ø±Ø³Ù‡" required></td></tr>
                    <tr><td>Ø¬Ù†Ø³ÛŒØª</td><td><select id="gender" required><option>Ø¬Ù†Ø³ÛŒØª</option><option value="boy">Ù¾Ø³Ø±</option><option value="girl">Ø¯Ø®ØªØ±</option><option value="mixed">Ù…Ø®ØªÙ„Ø·</option></select></td></tr>
                    <tr><td>Ú©Ø¯ Ù…Ø¯Ø±Ø³Ù‡</td><td><input id="schoolCode" placeholder="Ú©Ø¯ Ù…Ø¯Ø±Ø³Ù‡" required></td></tr>
                    <tr><td>Ù†ÙˆØ¹ Ù…Ù†Ø·Ù‚Ù‡</td><td><select id="areaType" required><option>Ù†ÙˆØ¹ Ù…Ù†Ø·Ù‚Ù‡</option><option>Ø´Ù‡Ø±ÛŒ</option><option>Ø±ÙˆØ³ØªØ§ÛŒÛŒ</option></select></td></tr>
                    <tr><td>Ù†Ø§Ù… Ù…Ø¯ÛŒØ±</td><td><input id="managerName" placeholder="Ù†Ø§Ù… Ù…Ø¯ÛŒØ±" required></td></tr>
                    <tr><td>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</td><td><input id="personnelCode" placeholder="Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ" required></td></tr>
                    <tr><td>ØªÙ„ÙÙ†</td><td><input id="phone" placeholder="ØªÙ„ÙÙ†" required></td></tr>
                    <tr><td>Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ</td><td><input id="educationDegree" placeholder="Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ" required></td></tr>
                    <tr><td>Ø³Ù†ÙˆØ§Øª Ø®Ø¯Ù…Øª</td><td><input id="serviceYears" type="number" placeholder="Ø³Ù†ÙˆØ§Øª Ø®Ø¯Ù…Øª" required></td></tr>
                    <tr><td>Ø³Ù†ÙˆØ§Øª Ù…Ø¯ÛŒØ±ÛŒØª</td><td><input id="managementYears" type="number" placeholder="Ø³Ù†ÙˆØ§Øª Ù…Ø¯ÛŒØ±ÛŒØª" required></td></tr>
                    <tr><td>ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´ Ø¢Ù…ÙˆØ²Ø§Ù†</td><td><input id="studentCount" type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´ Ø¢Ù…ÙˆØ²Ø§Ù†" required></td></tr>
                    <tr><td>ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø³Ù†Ù„</td><td><input id="staffCount" type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø³Ù†Ù„" required></td></tr>
                    <tr><td>Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡</td><td><label><input type="radio" name="courseType" value="Ú©ÙˆØ¯Ú©Ø³ØªØ§Ù†">Ú©ÙˆØ¯Ú©Ø³ØªØ§Ù†</label><label><input type="radio" name="courseType" value="Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ</label><label><input type="radio" name="courseType" value="Ù…ØªÙˆØ³Ø·Ù‡ Ø§ÙˆÙ„">Ù…ØªÙˆØ³Ø·Ù‡ Ø§ÙˆÙ„</label><label><input type="radio" name="courseType" value="Ù…ØªÙˆØ³Ø·Ù‡ Ø¯ÙˆÙ…">Ù…ØªÙˆØ³Ø·Ù‡ Ø¯ÙˆÙ…</label><label><input type="radio" name="courseType" value="Ù‡Ù†Ø±Ø³ØªØ§Ù†">Ù‡Ù†Ø±Ø³ØªØ§Ù†</label><label><input type="radio" name="courseType" value="Ú©Ø§Ù†ÙˆÙ†">Ú©Ø§Ù†ÙˆÙ†</label><label><input type="radio" name="courseType" value="Ø¯Ø§Ø±Ø§Ù„Ù‚Ø±Ø¢Ù†">Ø¯Ø§Ø±Ø§Ù„Ù‚Ø±Ø¢Ù†</label><label><input type="radio" name="courseType" value="Ø§Ø³ØªØ«Ù†Ø§Ø¦Ø§Øª">Ø§Ø³ØªØ«Ù†Ø§Ø¦Ø§Øª</label><label><input type="radio" name="courseType" value="Ù†Ø§Ø­ÛŒÙ‡">Ù†Ø§Ø­ÛŒÙ‡</label><label><input type="radio" name="courseType" value="Ø§Ø³ØªØ§Ù†">Ø§Ø³ØªØ§Ù†</label><label><input type="radio" name="courseType" value="Ø³Ø§ÛŒØ±">Ø³Ø§ÛŒØ±</label></td></tr>
                    <tr><td>ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø²Ø¯ÛŒØ¯</td><td><input id="visitDate" type="date" required><span id="shamsiDate" style="margin-right: 20px; font-weight: bold; color: var(--primary);"></span></td></tr>
                </table>
                <h2>Ù…Ø­ÙˆØ±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</h2>
                <div class="score-display" id="finalScoreDisplay">Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: Û°</div>
                <div id="axes">
                    <select id="axisSelect" onchange="loadCriteriaForAxis(this.value)">
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­ÙˆØ±</option>
                    </select>
                    <table>
                        <thead><tr><th style="width:60px;">ÙØ¹Ø§Ù„</th><th>Ø¹Ù†ÙˆØ§Ù† (Ù…Ø­ÙˆØ±)</th><th style="width:120px;">Ù†Ù…Ø±Ù‡</th><th style="width:300px;">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th></tr></thead>
                        <tbody id="criteriaBody"></tbody>
                    </table>
                </div>
                <h2>Ù„ÙˆÚ©ÛŒØ´Ù†, ØµØ¯Ø§ Ùˆ Ø¹Ú©Ø³</h2>
                <button onclick="getLocation()">Ø«Ø¨Øª Ù„ÙˆÚ©ÛŒØ´Ù†</button>
                <p id="location"></p>
                <div id="map"></div>
                <button onclick="startRecording()">Ø´Ø±ÙˆØ¹ Ø¶Ø¨Ø· ØµØ¯Ø§</button>
                <button onclick="stopRecording()">ØªÙˆÙ‚Ù Ø¶Ø¨Ø· ØµØ¯Ø§</button>
                <audio id="audioPlayer" controls></audio>
                <input type="file" id="photoUpload" accept="image/*" onchange="previewPhoto()">
                <img id="photoPreview" src="" alt="Ø¹Ú©Ø³ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ">
                <h2>Ø§Ù…Ø¶Ø§Ù‡Ø§</h2>
                <div>Ø§Ù…Ø¶Ø§ÛŒ Ø¨Ø§Ø²Ø±Ø³: <canvas id="inspectorSignature" class="signature"></canvas></div>
                <div>Ø§Ù…Ø¶Ø§ÛŒ Ù…Ø¯ÛŒØ±: <canvas id="managerSignature" class="signature"></canvas></div>
                <h3>Ø§Ù…Ø¶Ø§Ù‡Ø§ÛŒ Ù‡Ù…Ø±Ø§Ù‡Ø§Ù†</h3>
                <div id="companions"></div>
                <button onclick="addCompanion()">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ù…Ø±Ø§Ù‡</button>
                <button onclick="clearSignatures()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§Ù‡Ø§</button>
                <button onclick="manualSaveEvaluation()">Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø³ØªÛŒ</button>
            </div>
            <input id="searchInputEvaluations" type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
            <h2>Ø¬Ø¯ÙˆÙ„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡</h2>
            <div class="table-wrapper">
                <table id="evaluationsTable"><thead><tr><th>Ù†Ø§Ù… Ù…Ø¯ÛŒØ±</th><th>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</th><th>Ù†Ø§Ù… Ù…Ø¯Ø±Ø³Ù‡</th><th>Ù†ÙˆØ¹ Ù…Ø¯ÛŒØ±ÛŒØª</th><th>Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡</th><th>Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</th><th>Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø¯Ø±</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody></tbody></table>
            </div>
            <button onclick="exportEvaluationsToExcel()">Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</button>
            <button onclick="exportEvaluationsToJson()">Ø®Ø±ÙˆØ¬ÛŒ JSON Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</button>
            <input type="file" id="importEvaluationsJson" accept=".json" onchange="importEvaluationsFromJson()">
            <button onclick="document.getElementById('importEvaluationsJson').click()">ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† JSON Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</button>
        </div>
        <div id="reports-section" class="section" style="display:none;">
            <h1>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</h1>
            <input id="reportFilter" type="text" placeholder="ÙÛŒÙ„ØªØ±...">
            <select id="reportSort">
                <option value="score_desc">Ù†Ù…Ø±Ù‡ Ù†Ø²ÙˆÙ„ÛŒ</option>
                <option value="score_asc">Ù†Ù…Ø±Ù‡ ØµØ¹ÙˆØ¯ÛŒ</option>
                <option value="management">Ù†ÙˆØ¹ Ù…Ø¯ÛŒØ±ÛŒØª</option>
                <option value="name_asc">Ù†Ø§Ù… Ø§Ù„ÙØ¨Ø§ÛŒÛŒ ØµØ¹ÙˆØ¯ÛŒ</option>
                <option value="name_desc">Ù†Ø§Ù… Ø§Ù„ÙØ¨Ø§ÛŒÛŒ Ù†Ø²ÙˆÙ„ÛŒ</option>
            </select>
            <select id="reportGenderFilter"><option value="">Ø¬Ù†Ø³ÛŒØª</option></select>
            <select id="reportAreaFilter"><option value="">Ù†ÙˆØ¹ Ù…Ù†Ø·Ù‚Ù‡</option></select>
            <select id="reportCourseFilter"><option value="">Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡</option></select>
            <button onclick="applyReportFilterAndSort()">Ø§Ø¹Ù…Ø§Ù„</button>
            <button onclick="exportReportsToExcel()">Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
            <button onclick="exportReportsToPdf()">Ø®Ø±ÙˆØ¬ÛŒ PDF</button>
            <input id="searchInputReports" type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
            <div class="table-wrapper">
                <table id="reportsTable"><thead><tr><th>Ù†Ø§Ù… Ù…Ø¯ÛŒØ±</th><th>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</th><th>Ù†Ø§Ù… Ù…Ø¯Ø±Ø³Ù‡</th><th>Ù†ÙˆØ¹ Ù…Ø¯ÛŒØ±ÛŒØª</th><th>Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡</th><th>Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</th><th>ØªØ§Ø±ÛŒØ®</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
        <div id="analytics-section" class="section" style="display:none;">
            <h1>ğŸ” ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§</h1>
            <select id="selectEvalForAnalysis" onchange="loadSingleAnalytics(this.value)">
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</option>
            </select>
            <canvas id="barChart" style="margin-bottom: 30px;"></canvas>
            <canvas id="radarChart" style="margin-bottom: 30px;"></canvas>
            <canvas id="trendChart" style="margin-bottom: 30px;"></canvas>
            <canvas id="comparisonChart" style="margin-bottom: 30px;"></canvas>
            <div id="smartAnalysis"></div>
        </div>
        <div id="ranking-section" class="section" style="display:none;">
            <h1>ğŸ† Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ</h1>
            <div id="rankingFilters">
                <select id="rankManagementType"><option value="">Ù†ÙˆØ¹ Ù…Ø¯ÛŒØ±ÛŒØª</option></select>
                <select id="rankCourseType"><option value="">Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡</option></select>
                <select id="rankGender"><option value="">Ø¬Ù†Ø³ÛŒØª</option></select>
                <select id="rankAreaType"><option value="">Ù†ÙˆØ¹ Ù…Ù†Ø·Ù‚Ù‡</option></select>
                <button onclick="applyRankingFilters()">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
                <button onclick="exportRankingToExcel()">Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
                <button onclick="printRanking()">Ù¾Ø±ÛŒÙ†Øª</button>
            </div>
            <div class="table-wrapper">
                <table id="rankingTable"><thead><tr><th>Ù†Ø§Ù… Ù…Ø¯ÛŒØ±</th><th>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</th><th>Ù†Ø§Ù… Ù…Ø¯Ø±Ø³Ù‡</th><th>Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
        <div id="pdf-section" class="section" style="display:none;">
            <h1>ğŸ“„ Ø®Ø±ÙˆØ¬ÛŒ PDF</h1>
            <input id="searchInputPdf" type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
            <div class="table-wrapper">
                <table id="pdfTable"><thead><tr><th>Ù†Ø§Ù… Ù…Ø¯ÛŒØ±</th><th>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</th><th>Ù†Ø§Ù… Ù…Ø¯Ø±Ø³Ù‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
        <footer>Ø³Ø§Ø²Ù†Ø¯Ù‡: Ø­Ø³ÛŒÙ† Ù‡Ø§Ø¯ÛŒ Ù¾ÙˆØ± ğŸ”¨</footer>
    </div>
    <script>
        let db;
        let currentUser;
        let currentEvaluation = {};
        let editMode = false;
        let inspectorSigPad, managerSigPad;
        let companionSigPads = [];
        let debounceTimer;
        let companionCount = 0;
        let criteriaOrder = [];
        let recorder, audioChunks;
        let recordingTimer;
        let map;
        let allEvals = [];
        let axisCriteria = {}; // Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø­ÙˆØ±

        function initDB() {
            const request = indexedDB.open('SchoolEvalDB', 4);
            request.onupgradeneeded = e => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('users')) db.createObjectStore('users', {keyPath: 'personnelCode'});
                if (!db.objectStoreNames.contains('criteria')) db.createObjectStore('criteria', {keyPath: 'id', autoIncrement: true});
                if (!db.objectStoreNames.contains('evaluations')) db.createObjectStore('evaluations', {keyPath: 'id', autoIncrement: true});
                if (!db.objectStoreNames.contains('logs')) db.createObjectStore('logs', {keyPath: 'id', autoIncrement: true});
                if (!db.objectStoreNames.contains('criteriaOrder')) db.createObjectStore('criteriaOrder', {keyPath: 'id'});
            };
            request.onsuccess = e => {
                db = e.target.result;
                initDefaultUsers();
                loadCriteriaOrder();
            };
        }

        async function initDefaultUsers() {
            const users = [
                {
                    firstName: 'Super',
                    lastName: 'Admin',
                    fatherName: '',
                    personnelCode: '1',
                    nationalCode: '',
                    role: 'SUPER_ADMIN',
                    username: '1',
                    password: '1',
                    status: 'active'
                },
                {
                    firstName: 'Admin',
                    lastName: 'User',
                    fatherName: '',
                    personnelCode: '2',
                    nationalCode: '',
                    role: 'ADMIN',
                    username: '2',
                    password: '2',
                    status: 'active'
                },
                {
                    firstName: 'Evaluator',
                    lastName: 'User',
                    fatherName: '',
                    personnelCode: '3',
                    nationalCode: '',
                    role: 'EVALUATOR',
                    username: '3',
                    password: '3',
                    status: 'active'
                }
            ];
            for (let user of users) {
                const existing = await getFromStore('users', user.personnelCode);
                if (!existing) {
                    await addToStore('users', user);
                }
            }
            checkLogin();
        }

        function addToStore(storeName, item) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const req = tx.objectStore(storeName).add(item);
                req.onsuccess = () => resolve(req.result);
                req.onerror = reject;
            });
        }

        function putToStore(storeName, item) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const req = tx.objectStore(storeName).put(item);
                req.onsuccess = () => resolve(req.result);
                req.onerror = reject;
            });
        }

        function getFromStore(storeName, key) {
            return new Promise((resolve) => {
                const tx = db.transaction(storeName);
                const req = tx.objectStore(storeName).get(key);
                req.onsuccess = () => resolve(req.result);
            });
        }

        function getAllFromStore(storeName) {
            return new Promise((resolve) => {
                const tx = db.transaction(storeName);
                const req = tx.objectStore(storeName).getAll();
                req.onsuccess = () => resolve(req.result);
            });
        }

        function deleteFromStore(storeName, key) {
            const tx = db.transaction(storeName, 'readwrite');
            tx.objectStore(storeName).delete(key);
        }

        function checkLogin() {
            const userJson = localStorage.getItem('currentUser');
            if (userJson) {
                currentUser = JSON.parse(userJson);
                showApp();
            } else {
                document.getElementById('login').style.display = 'block';
                document.getElementById('app').style.display = 'none';
            }
        }

        function showApp() {
            document.getElementById('login').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            updateMenu();
            showSection('dashboard-section');
            loadUsers();
            loadCriteria();
            loadEvaluations();
            initEventListeners();
            loadDashboardStats();
        }

        function updateMenu() {
            const role = currentUser.role;
            document.getElementById('users').style.display = role === 'SUPER_ADMIN' ? 'block' : 'none';
            document.getElementById('formBuilder').style.display = role === 'SUPER_ADMIN' ? 'block' : 'none';
            document.getElementById('analytics').style.display = role !== 'EVALUATOR' ? 'block' : 'none';
        }

        function initEventListeners() {
            document.getElementById('hamburger').addEventListener('click', () => {
                const menu = document.getElementById('menu');
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            });
            document.querySelectorAll('#menu li').forEach(li => {
                li.addEventListener('click', () => {
                    showSection(li.id + '-section');
                    document.getElementById('menu').style.display = 'none';
                    if (li.id === 'evaluation') loadEvaluationForm();
                    if (li.id === 'analytics') {
                        loadAnalytics();
                        loadSelectForAnalysis();
                    }
                    if (li.id === 'ranking') {
                        loadRankingFilters();
                        applyRankingFilters();
                    }
                    if (li.id === 'pdf') loadPdfTable();
                    if (li.id === 'reports') {
                        loadReports();
                        loadReportFilters();
                        document.getElementById('reportSort').addEventListener('change', applyReportFilterAndSort);
                    }
                    if (li.id === 'logout') logout();
                });
            });
            document.getElementById('evaluationForm').addEventListener('input', autoSaveEvaluation);
            document.getElementById('evaluationForm').addEventListener('change', autoSaveEvaluation);
            document.getElementById('visitDate').addEventListener('change', updateShamsiDate);
            document.getElementById('searchInputUsers').addEventListener('input', () => searchTable('usersTable', 'searchInputUsers'));
            document.getElementById('searchInputCriteria').addEventListener('input', () => searchTable('criteriaTable', 'searchInputCriteria'));
            document.getElementById('searchInputEvaluations').addEventListener('input', () => searchTable('evaluationsTable', 'searchInputEvaluations'));
            document.getElementById('searchInputReports').addEventListener('input', () => searchTable('reportsTable', 'searchInputReports'));
            document.getElementById('searchInputPdf').addEventListener('input', () => searchTable('pdfTable', 'searchInputPdf'));
            document.getElementById('userForm').addEventListener('submit', (e) => { e.preventDefault(); saveUser(); });
            // Ø­Ø°Ù Ø§Ø¹Ù„Ø§Ù† Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡
            // setInterval(checkUnsavedChanges, 30000); Ø­Ø°Ù Ø´Ø¯
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            if (!username || !password) {
                Swal.fire({ title: 'Ø®Ø·Ø§', text: 'Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', icon: 'error' });
                return;
            }
            getAllFromStore('users').then(users => {
                const user = users.find(u => u.username === username && u.password === password && u.status === 'active');
                if (user) {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    addToStore('logs', { userId: user.personnelCode, action: 'login', timestamp: new Date().toISOString() });
                    currentUser = user;
                    showApp();
                } else {
                    Swal.fire({ title: 'Ø®Ø·Ø§', text: 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', icon: 'error' });
                }
            });
        }

        function logout() {
            addToStore('logs', { userId: currentUser.personnelCode, action: 'logout', timestamp: new Date().toISOString() });
            localStorage.removeItem('currentUser');
            currentUser = null;
            document.getElementById('app').style.display = 'none';
            document.getElementById('login').style.display = 'block';
            location.reload();
        }

        // User Management
        let currentUserEditCode = null;
        function saveUser() {
            const personnelCode = document.getElementById('personnelCode').value;
            const isEdit = !!currentUserEditCode;
            getFromStore('users', personnelCode).then(existingUser => {
                if (existingUser && !isEdit) {
                    Swal.fire({ title: 'Ø®Ø·Ø§', text: 'Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª', icon: 'error' });
                    return;
                }
                const user = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    fatherName: document.getElementById('fatherName').value,
                    personnelCode: personnelCode,
                    nationalCode: document.getElementById('nationalCode').value,
                    role: document.getElementById('role').value,
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value,
                    status: document.getElementById('status').value
                };
                putToStore('users', user).then(() => {
                    loadUsers();
                    Swal.fire({ title: 'Ù…ÙˆÙÙ‚', text: isEdit ? 'Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯' : 'Ú©Ø§Ø±Ø¨Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', icon: 'success' });
                    currentUserEditCode = null;
                });
                document.getElementById('userForm').reset();
            });
        }

        function loadUsers() {
            getAllFromStore('users').then(users => {
                const tbody = document.getElementById('usersTable').querySelector('tbody');
                tbody.innerHTML = '';
                users.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${u.firstName} ${u.lastName}</td><td>${u.personnelCode}</td><td>${u.role}</td><td>${u.status === 'active' ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}</td><td><button onclick="editUser('${u.personnelCode}')">ÙˆÛŒØ±Ø§ÛŒØ´</button><button onclick="deleteUser('${u.personnelCode}')">Ø­Ø°Ù</button></td>`;
                    tbody.appendChild(tr);
                });
            });
        }

        function editUser(code) {
            currentUserEditCode = code;
            getFromStore('users', code).then(user => {
                document.getElementById('firstName').value = user.firstName;
                document.getElementById('lastName').value = user.lastName;
                document.getElementById('fatherName').value = user.fatherName;
                document.getElementById('personnelCode').value = user.personnelCode;
                document.getElementById('personnelCode').disabled = true;
                document.getElementById('nationalCode').value = user.nationalCode;
                document.getElementById('role').value = user.role;
                document.getElementById('username').value = user.username;
                document.getElementById('password').value = user.password;
                document.getElementById('status').value = user.status;
            });
        }

        function deleteUser(code) {
            deleteFromStore('users', code);
            loadUsers();
        }

        function exportUsersToExcel() {
            getAllFromStore('users').then(users => {
                const data = users.map(u => ({
                    'Ù†Ø§Ù…': u.firstName,
                    'Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ': u.lastName,
                    'Ù†Ø§Ù… Ù¾Ø¯Ø±': u.fatherName,
                    'Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ': u.personnelCode,
                    'Ú©Ø¯ Ù…Ù„ÛŒ': u.nationalCode,
                    'Ù†Ù‚Ø´': u.role,
                    'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ': u.username,
                    'ÙˆØ¶Ø¹ÛŒØª': u.status
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù†');
                XLSX.writeFile(wb, 'users.xlsx');
            });
        }

        function exportUsersToJson() {
            getAllFromStore('users').then(users => {
                const blob = new Blob([JSON.stringify(users, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'users.json';
                a.click();
            });
        }

        function importUsersFromJson() {
            const file = document.getElementById('importUsersJson').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const users = JSON.parse(e.target.result);
                    users.forEach(user => putToStore('users', user));
                    loadUsers();
                    Swal.fire({ title: 'Ù…ÙˆÙÙ‚', text: 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù†Ø¯', icon: 'success' });
                };
                reader.readAsText(file);
            }
        }

        // Form Builder
        let currentCriterionId = null;
        function saveCriterion() {
            const criterion = {
                title: document.getElementById('title').value,
                axis: document.getElementById('axis').value,
                weight: parseFloat(document.getElementById('weight').value),
                enabled: document.getElementById('enabled').value === 'true'
            };
            if (currentCriterionId) {
                criterion.id = currentCriterionId;
                putToStore('criteria', criterion).then(() => loadCriteria());
                currentCriterionId = null;
            } else {
                addToStore('criteria', criterion).then(id => {
                    criteriaOrder.push(id);
                    saveCriteriaOrder();
                    loadCriteria();
                });
            }
            document.getElementById('criterionForm').reset();
        }

        function loadCriteria() {
            getAllFromStore('criteria').then(criteria => {
                const tbody = document.getElementById('sortableCriteria');
                tbody.innerHTML = '';
                const sortedCriteria = criteria.sort((a, b) => criteriaOrder.indexOf(a.id) - criteriaOrder.indexOf(b.id));
                sortedCriteria.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = c.id;
                    tr.className = c.enabled ? 'sortable' : 'disabled sortable';
                    tr.innerHTML = `<td>${c.title}</td><td>${c.axis}</td><td>${c.weight}</td><td>${c.enabled ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}</td><td><button onclick="editCriterion(${c.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button><button onclick="deleteCriterion(${c.id})">Ø­Ø°Ù</button></td>`;
                    tbody.appendChild(tr);
                });
                Sortable.create(tbody, {
                    animation: 150,
                    onEnd: () => {
                        criteriaOrder = Array.from(tbody.querySelectorAll('tr')).map(tr => parseInt(tr.dataset.id));
                    }
                });
            });
        }

        function editCriterion(id) {
            getFromStore('criteria', id).then(c => {
                document.getElementById('title').value = c.title;
                document.getElementById('axis').value = c.axis;
                document.getElementById('weight').value = c.weight;
                document.getElementById('enabled').value = c.enabled ? 'true' : 'false';
                currentCriterionId = id;
            });
        }

        function deleteCriterion(id) {
            deleteFromStore('criteria', id);
            criteriaOrder = criteriaOrder.filter(cid => cid !== id);
            saveCriteriaOrder();
            loadCriteria();
        }

        function saveCriteriaOrder() {
            putToStore('criteriaOrder', {id: 1, order: criteriaOrder});
        }

        function loadCriteriaOrder() {
            getFromStore('criteriaOrder', 1).then(orderObj => {
                criteriaOrder = orderObj ? orderObj.order : [];
            });
        }

        function exportCriteriaToJson() {
            getAllFromStore('criteria').then(criteria => {
                const blob = new Blob([JSON.stringify(criteria, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'criteria.json';
                a.click();
            });
        }

        function importCriteriaFromJson() {
            const file = document.getElementById('importCriteriaJson').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const criteria = JSON.parse(e.target.result);
                    criteria.forEach(crit => putToStore('criteria', crit));
                    loadCriteria();
                    Swal.fire({ title: 'Ù…ÙˆÙÙ‚', text: 'Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù†Ø¯', icon: 'success' });
                };
                reader.readAsText(file);
            }
        }

        // Evaluation
        function loadEvaluationForm(evalId = null) {
            editMode = !!evalId;
            companionSigPads = [];
            companionCount = 0;
            document.getElementById('companions').innerHTML = '';
            document.getElementById('location').textContent = currentEvaluation.location || '';
            document.getElementById('audioPlayer').src = currentEvaluation.audio || '';
            document.getElementById('photoPreview').src = currentEvaluation.photo || '';
            if (editMode) {
                getFromStore('evaluations', evalId).then(evalData => {
                    if (evalData) {
                        currentEvaluation = evalData;
                        populateEvaluationForm();
                        updateFinalScore();
                        if (currentEvaluation.companions) {
                            currentEvaluation.companions.forEach((comp, index) => addCompanion(comp.name, comp.code, comp.signature));
                        }
                        if (currentEvaluation.location) {
                            const [lat, lng] = currentEvaluation.location.split(' ')[1].split(',');
                            initMap(lat, lng);
                        }
                    } else {
                        Swal.fire({ title: 'Ø®Ø·Ø§', text: 'Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', icon: 'error' });
                    }
                });
            } else {
                currentEvaluation = { companions: [], enabledCriteria: [], scores: {}, notes: {}, location: '', audio: '', photo: '' };
                populateEvaluationForm();
                updateFinalScore();
            }
            initSignatures();
            updateShamsiDate();
            loadAxisSelect();
        }

        function loadAxisSelect() {
            getAllFromStore('criteria').then(criteria => {
                axisCriteria = {};
                criteria.forEach(c => {
                    if (!axisCriteria[c.axis]) axisCriteria[c.axis] = [];
                    axisCriteria[c.axis].push(c);
                });
                const select = document.getElementById('axisSelect');
                select.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­ÙˆØ±</option>';
                Object.keys(axisCriteria).forEach(axis => {
                    const option = document.createElement('option');
                    option.value = axis;
                    option.textContent = axis;
                    select.appendChild(option);
                });
            });
        }

        function loadCriteriaForAxis(axis) {
            const criteria = axisCriteria[axis] || [];
            const tbody = document.getElementById('criteriaBody');
            tbody.innerHTML = '';
            criteria.forEach(c => {
                const enabled = currentEvaluation.enabledCriteria?.includes(c.id) ?? c.enabled;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="criterion-toggle" data-id="${c.id}" ${enabled ? 'checked' : ''}></td>
                    <td><strong>${c.title}</strong><br><small style="color:#64748b;">(${c.axis})</small></td>
                    <td><select id="score-${c.id}" ${!enabled ? 'disabled' : ''}>
                        <option value="4" ${currentEvaluation.scores?.[c.id] === 4 ? 'selected' : ''}>Û´</option>
                        <option value="3" ${currentEvaluation.scores?.[c.id] === 3 ? 'selected' : ''}>Û³</option>
                        <option value="2" ${currentEvaluation.scores?.[c.id] === 2 ? 'selected' : ''}>Û²</option>
                        <option value="1" ${currentEvaluation.scores?.[c.id] === 1 ? 'selected' : ''}>Û±</option>
                    </select></td>
                    <td><textarea id="notes-${c.id}" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø§Ø®ØªÛŒØ§Ø±ÛŒ">${currentEvaluation.notes?.[c.id] || ''}</textarea></td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.criterion-toggle').forEach(toggle => toggle.addEventListener('change', toggleCriterion));
            document.querySelectorAll('#criteriaBody select, #criteriaBody textarea').forEach(el => el.addEventListener('change', updateFinalScore));
        }

        function populateEvaluationForm() {
            document.getElementById('managementType').value = currentEvaluation.managementType || '';
            document.getElementById('schoolName').value = currentEvaluation.schoolName || '';
            document.getElementById('gender').value = currentEvaluation.gender || '';
            document.getElementById('schoolCode').value = currentEvaluation.schoolCode || '';
            document.getElementById('areaType').value = currentEvaluation.areaType || '';
            document.getElementById('managerName').value = currentEvaluation.managerName || '';
            document.getElementById('personnelCode').value = currentEvaluation.personnelCode || '';
            document.getElementById('phone').value = currentEvaluation.phone || '';
            document.getElementById('educationDegree').value = currentEvaluation.educationDegree || '';
            document.getElementById('serviceYears').value = currentEvaluation.serviceYears || 0;
            document.getElementById('managementYears').value = currentEvaluation.managementYears || 0;
            document.getElementById('studentCount').value = currentEvaluation.studentCount || 0;
            document.getElementById('staffCount').value = currentEvaluation.staffCount || 0;
            document.getElementById('visitDate').value = currentEvaluation.visitDate || '';
            const courseType = currentEvaluation.courseType || '';
            document.querySelectorAll('#evaluationForm input[type="radio"][name="courseType"]').forEach(rb => rb.checked = rb.value === courseType);
        }

        function toggleCriterion(e) {
            const id = parseInt(e.target.dataset.id);
            const enabled = e.target.checked;
            const select = document.getElementById(`score-${id}`);
            select.disabled = !enabled;
            if (!currentEvaluation.enabledCriteria) currentEvaluation.enabledCriteria = [];
            if (enabled && !currentEvaluation.enabledCriteria.includes(id)) currentEvaluation.enabledCriteria.push(id);
            if (!enabled) currentEvaluation.enabledCriteria = currentEvaluation.enabledCriteria.filter(cid => cid !== id);
            updateFinalScore();
            autoSaveEvaluation();
        }

        function updateFinalScore() {
            getAllFromStore('criteria').then(criteria => {
                const finalScore = calculateFinalScore(currentEvaluation, criteria);
                document.getElementById('finalScoreDisplay').textContent = `Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: ${finalScore.toFixed(2)}`;
                const color = finalScore < 50 ? 'red' : finalScore <= 75 ? '#eab308' : '#22c55e';
                document.getElementById('finalScoreDisplay').style.color = color;
            });
        }

        function calculateFinalScore(evalData, criteria) {
            if (!evalData.enabledCriteria || evalData.enabledCriteria.length === 0) return 0;
            let sumPercent = 0, totalWeight = 0;
            criteria.filter(c => evalData.enabledCriteria.includes(c.id)).forEach(c => {
                const score = evalData.scores[c.id] || 1;
                const percent = (score / 4) * 100;
                sumPercent += percent * c.weight;
                totalWeight += c.weight;
            });
            return totalWeight > 0 ? (sumPercent / totalWeight) : 0;
        }

        function initSignatures() {
            const inspectorCanvas = document.getElementById('inspectorSignature');
            const managerCanvas = document.getElementById('managerSignature');
            inspectorSigPad = new SignaturePad(inspectorCanvas, { penColor: '#1e293b' });
            managerSigPad = new SignaturePad(managerCanvas, { penColor: '#1e293b' });
        }

        function addCompanion(name = '', code = '', signature = '') {
            const index = companionCount++;
            const div = document.createElement('div');
            div.className = 'companion';
            div.innerHTML = `
                <input id="comp-name-${index}" placeholder="Ù†Ø§Ù… Ù‡Ù…Ø±Ø§Ù‡" value="${name}">
                <input id="comp-code-${index}" placeholder="Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ Ù‡Ù…Ø±Ø§Ù‡" value="${code}">
                <div><canvas id="comp-sig-${index}" class="signature"></canvas></div>
                <button onclick="removeCompanion(${index})">Ø­Ø°Ù</button>
            `;
            document.getElementById('companions').appendChild(div);
            const canvas = document.getElementById(`comp-sig-${index}`);
            const sigPad = new SignaturePad(canvas, { penColor: '#1e293b' });
            companionSigPads[index] = sigPad;
            if (signature) sigPad.fromDataURL(signature);
        }

        function removeCompanion(index) {
            document.getElementById(`comp-name-${index}`).parentElement.remove();
            companionSigPads.splice(index, 1);
            companionCount--;
        }

        function clearSignatures() {
            inspectorSigPad.clear();
            managerSigPad.clear();
            companionSigPads.forEach(pad => pad.clear());
        }

        function autoSaveEvaluation() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(saveEvaluation, 1200);
        }

        function manualSaveEvaluation() {
            if (isFormComplete()) {
                saveEvaluation(true);
            } else {
                Swal.fire({ title: 'Ø®Ø·Ø§', text: 'Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', icon: 'error' });
            }
        }

        function isFormComplete() {
            const requiredFields = document.querySelectorAll('#evaluationForm input[required], #evaluationForm select[required]');
            for (let field of requiredFields) {
                if (!field.value.trim()) return false;
            }
            for (let id of currentEvaluation.enabledCriteria || []) {
                const score = document.getElementById(`score-${id}`);
                if (!score.value) return false;
            }
            return true;
        }

        function saveEvaluation(showToast = false) {
            currentEvaluation.managementType = document.getElementById('managementType').value;
            currentEvaluation.schoolName = document.getElementById('schoolName').value;
            currentEvaluation.gender = document.getElementById('gender').value;
            currentEvaluation.schoolCode = document.getElementById('schoolCode').value;
            currentEvaluation.areaType = document.getElementById('areaType').value;
            currentEvaluation.managerName = document.getElementById('managerName').value;
            currentEvaluation.personnelCode = document.getElementById('personnelCode').value;
            currentEvaluation.phone = document.getElementById('phone').value;
            currentEvaluation.educationDegree = document.getElementById('educationDegree').value;
            currentEvaluation.serviceYears = parseInt(document.getElementById('serviceYears').value) || 0;
            currentEvaluation.managementYears = parseInt(document.getElementById('managementYears').value) || 0;
            currentEvaluation.studentCount = parseInt(document.getElementById('studentCount').value) || 0;
            currentEvaluation.staffCount = parseInt(document.getElementById('staffCount').value) || 0;
            currentEvaluation.visitDate = document.getElementById('visitDate').value;
            currentEvaluation.courseType = document.querySelector('#evaluationForm input[type="radio"][name="courseType"]:checked') ? document.querySelector('#evaluationForm input[type="radio"][name="courseType"]:checked').value : '';

            getAllFromStore('criteria').then(criteria => {
                currentEvaluation.scores = {};
                currentEvaluation.notes = {};
                criteria.forEach(c => {
                    if (currentEvaluation.enabledCriteria?.includes(c.id)) {
                        const scoreEl = document.getElementById(`score-${c.id}`);
                        currentEvaluation.scores[c.id] = scoreEl ? parseInt(scoreEl.value) : 1;
                        const noteEl = document.getElementById(`notes-${c.id}`);
                        currentEvaluation.notes[c.id] = noteEl ? noteEl.value : '';
                    }
                });
                currentEvaluation.inspectorSignature = inspectorSigPad.toDataURL();
                currentEvaluation.managerSignature = managerSigPad.toDataURL();
                currentEvaluation.companions = [];
                for (let i = 0; i < companionCount; i++) {
                    const nameEl = document.getElementById(`comp-name-${i}`);
                    const codeEl = document.getElementById(`comp-code-${i}`);
                    if (nameEl && codeEl) {
                        currentEvaluation.companions.push({
                            name: nameEl.value,
                            code: codeEl.value,
                            signature: companionSigPads[i]?.toDataURL() || ''
                        });
                    }
                }
                currentEvaluation.savedAt = new Date().toISOString();
                currentEvaluation.finalScore = calculateFinalScore(currentEvaluation, criteria);
                currentEvaluation.location = document.getElementById('location').textContent;
                currentEvaluation.audio = document.getElementById('audioPlayer').src;
                currentEvaluation.photo = document.getElementById('photoPreview').src;

                const promise = currentEvaluation.id ? putToStore('evaluations', currentEvaluation) : addToStore('evaluations', currentEvaluation);
                promise.then(id => {
                    if (!currentEvaluation.id) currentEvaluation.id = id;
                    if (showToast) {
                        Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, title: 'Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', icon: 'success' });
                    }
                    loadEvaluations();
                    updateFinalScore();
                });
            });
        }

        function updateShamsiDate() {
            const gregDate = document.getElementById('visitDate').value;
            if (gregDate) {
                const date = new Date(gregDate);
                document.getElementById('shamsiDate').textContent = gregorianToJalali(date);
            } else {
                document.getElementById('shamsiDate').textContent = '';
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    document.getElementById('location').textContent = `Ù„ÙˆÚ©ÛŒØ´Ù†: ${position.coords.latitude}, ${position.coords.longitude}`;
                    Swal.fire({ title: 'Ù…ÙˆÙÙ‚', text: 'Ù„ÙˆÚ©ÛŒØ´Ù† Ø«Ø¨Øª Ø´Ø¯', icon: 'success' });
                    initMap(position.coords.latitude, position.coords.longitude);
                }, error => {
                    Swal.fire({ title: 'Ø®Ø·Ø§', text: 'Ø¯Ø±ÛŒØ§ÙØª Ù„ÙˆÚ©ÛŒØ´Ù† Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯', icon: 'error' });
                });
            } else {
                Swal.fire({ title: 'Ø®Ø·Ø§', text: 'Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ù„ÙˆÚ©ÛŒØ´Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯', icon: 'error' });
            }
        }

        function initMap(lat, lng) {
            if (map) map.remove();
            map = L.map('map').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            L.marker([lat, lng]).addTo(map);
        }

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                recorder = new MediaRecorder(stream);
                audioChunks = [];
                recorder.ondataavailable = e => audioChunks.push(e.data);
                recorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    document.getElementById('audioPlayer').src = URL.createObjectURL(audioBlob);
                };
                recorder.start();
                recordingTimer = setTimeout(stopRecording, 180000);
            });
        }

        function stopRecording() {
            recorder.stop();
            clearTimeout(recordingTimer);
        }

        function previewPhoto() {
            const file = document.getElementById('photoUpload').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => document.getElementById('photoPreview').src = e.target.result;
                reader.readAsDataURL(file);
            }
        }

        function loadEvaluations() {
            getAllFromStore('evaluations').then(evals => {
                allEvals = evals;
                const tbody = document.getElementById('evaluationsTable').querySelector('tbody');
                tbody.innerHTML = '';
                evals.forEach(e => {
                    const tr = document.createElement('tr');
                    const shamsiDate = gregorianToJalali(new Date(e.savedAt));
                    const color = getHealthIndexColor(e.finalScore);
                    tr.innerHTML = `<td>${e.managerName}</td><td>${e.personnelCode}</td><td>${e.schoolName}</td><td>${e.managementType}</td><td>${e.courseType}</td><td style="color: ${color};">${e.finalScore.toFixed(2)}</td><td>${shamsiDate}</td><td><button onclick="viewEvaluation(${e.id})">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button><button onclick="editEvaluation(${e.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button><button onclick="exportPdf(${e.id})">PDF</button><button onclick="deleteEvaluation(${e.id})">Ø­Ø°Ù</button></td>`;
                    tbody.appendChild(tr);
                });
            });
        }

        function deleteEvaluation(id) {
            Swal.fire({
                title: 'Ø­Ø°Ù Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ',
                text: "Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ø¨Ù„Ù‡, Ø­Ø°Ù Ú©Ù†!',
                cancelButtonText: 'Ù„ØºÙˆ'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteFromStore('evaluations', id);
                    loadEvaluations();
                    Swal.fire('Ø­Ø°Ù Ø´Ø¯!', 'Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.', 'success');
                }
            });
        }

        function getHealthIndexColor(score) {
            if (score < 50) return 'red';
            if (score <= 75) return 'yellow';
            return 'green';
        }

        function viewEvaluation(id) {
            loadEvaluationForm(id);
            document.querySelectorAll('#evaluationForm input, select, textarea, button:not([onclick="clearSignatures()"])').forEach(el => el.disabled = true);
            inspectorSigPad.off();
            managerSigPad.off();
            companionSigPads.forEach(pad => pad.off());
        }

        function editEvaluation(id) {
            loadEvaluationForm(id);
        }

        function exportPdf(id) {
            getFromStore('evaluations', id).then(evalData => {
                if (!evalData) {
                    Swal.fire({ title: 'Ø®Ø·Ø§', text: 'Ø¯Ø§Ø¯Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', icon: 'error' });
                    return;
                }
                getAllFromStore('criteria').then(criteria => {
                    const pdfContent = createCompactPdfContent(evalData, criteria);
                    const opt = {
                        margin: 0.1,
                        filename: `${evalData.schoolName}.pdf`,
                        image: { type: 'jpeg', quality: 0.95 },
                        html2canvas: { scale: 1.2 },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                        pagebreak: { mode: ['avoid-all'] }
                    };
                    html2pdf().from(pdfContent).set(opt).save();
                });
            });
        }

        function createCompactPdfContent(evalData, criteria) {
            const div = document.createElement('div');
            div.style.fontSize = '5pt'; // Ú©ÙˆÚ†Ú©ØªØ± Ú©Ø±Ø¯Ù† ÙÙˆÙ†Øª Ø¨Ø±Ø§ÛŒ Ù…ØµØ±Ù Ú©Ù…ØªØ± Ú©Ø§ØºØ°
            div.style.lineHeight = '1.0';
            div.style.padding = '3mm';
            let criteriaHtml = '';
            criteria.filter(c => evalData.enabledCriteria.includes(c.id)).forEach(c => {
                criteriaHtml += `<tr><td>${c.title} (${c.axis})</td><td>${evalData.scores[c.id]}</td><td>${evalData.notes[c.id] || 'Ù†Ø¯Ø§Ø±Ø¯'}</td></tr>`;
            });
            let companionsHtml = '';
            evalData.companions.forEach((comp, i) => {
                companionsHtml += `<tr><td>Ù‡Ù…Ø±Ø§Ù‡ ${i+1}: ${comp.name} (${comp.code})</td><td><img src="${comp.signature}" style="width: 50mm; height: 20mm;"></td></tr>`;
            });
            div.innerHTML = `
                <h1 style="font-size: 8pt; text-align: center; margin-bottom: 3mm;">Ú¯Ø²Ø§Ø±Ø´ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ ${evalData.managerName} - ${evalData.schoolName}</h1>
                <table style="width: 100%; border-collapse: collapse; font-size: 5pt; border: 1px solid black;">
                    <tr><th colspan="3">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡</th></tr>
                    <tr><td>Ù†ÙˆØ¹ Ù…Ø¯ÛŒØ±ÛŒØª: ${evalData.managementType}</td><td>Ù†Ø§Ù… Ù…Ø¯Ø±Ø³Ù‡: ${evalData.schoolName}</td><td>Ø¬Ù†Ø³ÛŒØª: ${evalData.gender}</td></tr>
                    <tr><td>Ú©Ø¯ Ù…Ø¯Ø±Ø³Ù‡: ${evalData.schoolCode}</td><td>Ù†ÙˆØ¹ Ù…Ù†Ø·Ù‚Ù‡: ${evalData.areaType}</td><td>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ: ${evalData.personnelCode}</td></tr>
                    <tr><td>ØªÙ„ÙÙ†: ${evalData.phone}</td><td>Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ: ${evalData.educationDegree}</td><td>Ø³Ù†ÙˆØ§Øª Ø®Ø¯Ù…Øª: ${evalData.serviceYears}</td></tr>
                    <tr><td>Ø³Ù†ÙˆØ§Øª Ù…Ø¯ÛŒØ±ÛŒØª: ${evalData.managementYears}</td><td>ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´ Ø¢Ù…ÙˆØ²Ø§Ù†: ${evalData.studentCount}</td><td>ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø³Ù†Ù„: ${evalData.staffCount}</td></tr>
                    <tr><td>Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡: ${evalData.courseType}</td><td>ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø²Ø¯ÛŒØ¯: ${gregorianToJalali(new Date(evalData.visitDate))}</td><td>Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: ${evalData.finalScore.toFixed(2)}</td></tr>
                    <tr><th colspan="3">Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</th></tr>
                    ${criteriaHtml}
                    <tr><th colspan="3">Ù„ÙˆÚ©ÛŒØ´Ù†: ${evalData.location || 'Ù†Ø¯Ø§Ø±Ø¯'}</th></tr>
                    <tr><td colspan="3"><img src="${evalData.photo || ''}" style="max-width: 50mm; max-height: 30mm;"></td></tr>
                    <tr><th colspan="3">Ø§Ù…Ø¶Ø§Ù‡Ø§</th></tr>
                    <tr><td>Ø¨Ø§Ø²Ø±Ø³: <img src="${evalData.inspectorSignature}" style="width: 50mm; height: 20mm;"></td><td colspan="2">Ù…Ø¯ÛŒØ±: <img src="${evalData.managerSignature}" style="width: 50mm; height: 20mm;"></td></tr>
                    ${companionsHtml}
                </table>
            `;
            return div;
        }

        function exportEvaluationsToExcel() {
            getAllFromStore('evaluations').then(evals => {
                getAllFromStore('criteria').then(criteria => {
                    const data = evals.map(e => {
                        const row = {
                            'Ù†Ø§Ù… Ù…Ø¯ÛŒØ±': e.managerName,
                            'Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ': e.personnelCode,
                            'Ù†Ø§Ù… Ù…Ø¯Ø±Ø³Ù‡': e.schoolName,
                            'Ù†ÙˆØ¹ Ù…Ø¯ÛŒØ±ÛŒØª': e.managementType,
                            'Ø¬Ù†Ø³ÛŒØª': e.gender,
                            'Ú©Ø¯ Ù…Ø¯Ø±Ø³Ù‡': e.schoolCode,
                            'Ù†ÙˆØ¹ Ù…Ù†Ø·Ù‚Ù‡': e.areaType,
                            'ØªÙ„ÙÙ†': e.phone,
                            'Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ': e.educationDegree,
                            'Ø³Ù†ÙˆØ§Øª Ø®Ø¯Ù…Øª': e.serviceYears,
                            'Ø³Ù†ÙˆØ§Øª Ù…Ø¯ÛŒØ±ÛŒØª': e.managementYears,
                            'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´ Ø¢Ù…ÙˆØ²Ø§Ù†': e.studentCount,
                            'ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø³Ù†Ù„': e.staffCount,
                            'Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡': e.courseType,
                            'ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø²Ø¯ÛŒØ¯': e.visitDate,
                            'Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ': e.finalScore.toFixed(2),
                            'Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø¯Ø±': gregorianToJalali(new Date(e.savedAt)),
                            'Ù„ÙˆÚ©ÛŒØ´Ù†': e.location,
                            'Ø¹Ú©Ø³': e.photo ? 'Ø¨Ù„Ù‡' : 'Ø®ÛŒØ±',
                            'ØµØ¯Ø§': e.audio ? 'Ø¨Ù„Ù‡' : 'Ø®ÛŒØ±'
                        };
                        criteria.forEach(c => {
                            if (e.scores[c.id]) {
                                row[`Ù†Ù…Ø±Ù‡ ${c.title}`] = e.scores[c.id];
                                row[`ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ${c.title}`] = e.notes[c.id] || '';
                            }
                        });
                        e.companions.forEach((comp, i) => {
                            row[`Ù‡Ù…Ø±Ø§Ù‡ ${i+1} Ù†Ø§Ù…`] = comp.name;
                            row[`Ù‡Ù…Ø±Ø§Ù‡ ${i+1} Ú©Ø¯`] = comp.code;
                            row[`Ù‡Ù…Ø±Ø§Ù‡ ${i+1} Ø§Ù…Ø¶Ø§`] = 'Ø¨Ù„Ù‡';
                        });
                        row['Ø§Ù…Ø¶Ø§ÛŒ Ø¨Ø§Ø²Ø±Ø³'] = 'Ø¨Ù„Ù‡';
                        row['Ø§Ù…Ø¶Ø§ÛŒ Ù…Ø¯ÛŒØ±'] = 'Ø¨Ù„Ù‡';
                        return row;
                    });
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§');
                    XLSX.writeFile(wb, 'evaluations.xlsx');
                });
            });
        }

        function exportEvaluationsToJson() {
            getAllFromStore('evaluations').then(evals => {
                const blob = new Blob([JSON.stringify(evals, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'evaluations.json';
                a.click();
            });
        }

        function importEvaluationsFromJson() {
            const file = document.getElementById('importEvaluationsJson').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const evals = JSON.parse(e.target.result);
                    evals.forEach(evalItem => putToStore('evaluations', evalItem));
                    loadEvaluations();
                    Swal.fire({ title: 'Ù…ÙˆÙÙ‚', text: 'Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù†Ø¯', icon: 'success' });
                };
                reader.readAsText(file);
            }
        }

        // Charts and Analytics
        function loadAnalytics() {
            getAllFromStore('evaluations').then(evals => {
                if (evals.length === 0) {
                    document.getElementById('smartAnalysis').innerHTML = '<p>Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</p>';
                    return;
                }
                getAllFromStore('criteria').then(criteria => {
                    const axes = [...new Set(criteria.map(c => c.axis))];
                    const avgPerAxis = axes.map(axis => {
                        let sum = 0, count = 0;
                        evals.forEach(e => {
                            criteria.filter(c => c.axis === axis && e.enabledCriteria?.includes(c.id)).forEach(c => {
                                sum += e.scores[c.id] || 0;
                                count++;
                            });
                        });
                        return count > 0 ? sum / count : 0;
                    });
                    new Chart(document.getElementById('barChart'), {
                        type: 'bar',
                        data: { labels: axes, datasets: [{ label: 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù†Ù…Ø±Ù‡ Ù…Ø­ÙˆØ±', data: avgPerAxis, backgroundColor: '#1565c0' }] },
                        options: { scales: { y: { beginAtZero: true } } }
                    });

                    if (evals.length > 0) {
                        const avgRadarData = axes.map(axis => {
                            let sum = 0, count = 0;
                            evals.forEach(e => {
                                criteria.filter(c => c.axis === axis && e.enabledCriteria?.includes(c.id)).forEach(c => {
                                    sum += (e.scores[c.id] || 0) / 4 * 100;
                                    count++;
                                });
                            });
                            return count > 0 ? sum / count : 0;
                        });
                        new Chart(document.getElementById('radarChart'), {
                            type: 'radar',
                            data: { labels: axes, datasets: [{ label: 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø±ØµØ¯ Ù†Ù…Ø±Ù‡ Ù…Ø­ÙˆØ±Ù‡Ø§', data: avgRadarData, fill: true, backgroundColor: 'rgba(21,101,192,0.2)', borderColor: '#1565c0' }] }
                        });
                    }

                    const sortedEvals = evals.sort((a,b) => new Date(a.savedAt) - new Date(b.savedAt));
                    const dates = sortedEvals.map(e => gregorianToJalali(new Date(e.savedAt)));
                    const scores = sortedEvals.map(e => e.finalScore);
                    new Chart(document.getElementById('trendChart'), {
                        type: 'line',
                        data: { labels: dates, datasets: [{ label: 'Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ', data: scores, borderColor: '#1565c0' }] }
                    });

                    const managementTypes = [...new Set(evals.map(e => e.managementType))];
                    const datasets = managementTypes.map(type => {
                        const typeEvals = evals.filter(e => e.managementType === type).sort((a,b) => new Date(a.savedAt) - new Date(b.savedAt));
                        const typeDates = typeEvals.map(e => gregorianToJalali(new Date(e.savedAt)));
                        const typeScores = typeEvals.map(e => e.finalScore);
                        return {
                            label: type,
                            data: typeScores,
                            borderColor: '#' + Math.floor(Math.random()*16777215).toString(16)
                        };
                    });
                    new Chart(document.getElementById('comparisonChart'), {
                        type: 'line',
                        data: { labels: dates, datasets: datasets },
                        options: { scales: { y: { beginAtZero: true } } }
                    });

                    const analysis = generateSmartAnalysis(evals, criteria);
                    const table = document.createElement('table');
                    table.innerHTML = '<thead><tr><th>Ø®Ù„Ø§ØµÙ‡</th><th>Ø±Ø§Ù‡Ø¨Ø±Ø¯ÛŒ</th><th>Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ</th><th>Ø±Ø§Ù‡ Ø­Ù„</th></tr></thead><tbody><tr><td>' + analysis.summary + '</td><td>' + analysis.strategic + '</td><td>' + analysis.psychology + '</td><td>' + analysis.solution + '</td></tr></tbody>';
                    document.getElementById('smartAnalysis').innerHTML = '';
                    document.getElementById('smartAnalysis').appendChild(table);
                });
            });
        }

        function loadSingleAnalytics(evalId) {
            if (!evalId) return loadAnalytics();
            getFromStore('evaluations', parseInt(evalId)).then(singleEval => {
                getAllFromStore('criteria').then(criteria => {
                    const axes = [...new Set(criteria.map(c => c.axis))];
                    const avgPerAxis = axes.map(axis => {
                        let sum = 0, count = 0;
                        criteria.filter(c => c.axis === axis && singleEval.enabledCriteria?.includes(c.id)).forEach(c => {
                            sum += singleEval.scores[c.id] || 0;
                            count++;
                        });
                        return count > 0 ? sum / count : 0;
                    });
                    if (document.getElementById('barChart').getContext('2d').chart) document.getElementById('barChart').getContext('2d').chart.destroy();
                    new Chart(document.getElementById('barChart'), {
                        type: 'bar',
                        data: { labels: axes, datasets: [{ label: 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù†Ù…Ø±Ù‡ Ù…Ø­ÙˆØ±', data: avgPerAxis, backgroundColor: '#1565c0' }] },
                        options: { scales: { y: { beginAtZero: true } } }
                    });

                    const avgRadarData = axes.map(axis => {
                        let sum = 0, count = 0;
                        criteria.filter(c => c.axis === axis && singleEval.enabledCriteria?.includes(c.id)).forEach(c => {
                            sum += (singleEval.scores[c.id] || 0) / 4 * 100;
                            count++;
                        });
                        return count > 0 ? sum / count : 0;
                    });
                    if (document.getElementById('radarChart').getContext('2d').chart) document.getElementById('radarChart').getContext('2d').chart.destroy();
                    new Chart(document.getElementById('radarChart'), {
                        type: 'radar',
                        data: { labels: axes, datasets: [{ label: 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø±ØµØ¯ Ù†Ù…Ø±Ù‡ Ù…Ø­ÙˆØ±Ù‡Ø§', data: avgRadarData, fill: true, backgroundColor: 'rgba(21,101,192,0.2)', borderColor: '#1565c0' }] }
                    });

                    if (document.getElementById('trendChart').getContext('2d').chart) document.getElementById('trendChart').getContext('2d').chart.destroy();
                    if (document.getElementById('comparisonChart').getContext('2d').chart) document.getElementById('comparisonChart').getContext('2d').chart.destroy();

                    const analysis = generateSmartAnalysis([singleEval], criteria);
                    const table = document.createElement('table');
                    table.innerHTML = '<thead><tr><th>Ø®Ù„Ø§ØµÙ‡</th><th>Ø±Ø§Ù‡Ø¨Ø±Ø¯ÛŒ</th><th>Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ</th><th>Ø±Ø§Ù‡ Ø­Ù„</th></tr></thead><tbody><tr><td>' + analysis.summary + '</td><td>' + analysis.strategic + '</td><td>' + analysis.psychology + '</td><td>' + analysis.solution + '</td></tr></tbody>';
                    document.getElementById('smartAnalysis').innerHTML = '';
                    document.getElementById('smartAnalysis').appendChild(table);
                });
            });
        }

        function loadSelectForAnalysis() {
            getAllFromStore('evaluations').then(evals => {
                const select = document.getElementById('selectEvalForAnalysis');
                select.innerHTML = '<option value="">Ù‡Ù…Ù‡</option>';
                evals.forEach(e => {
                    const option = document.createElement('option');
                    option.value = e.id;
                    option.textContent = `${e.managerName} (${e.personnelCode}) - ${e.schoolName}`;
                    select.appendChild(option);
                });
            });
        }

        function generateSmartAnalysis(evals, criteria) {
            let summary = '', strategic = '', psychology = '', solution = '';
            // Ø³Ø·Ø­ Ø¨Ù†Ø¯ÛŒ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª
            const levelAnalyses = {
                high: ['Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¹Ø§Ù„ÛŒ', 'Ø§Ø¯Ø§Ù…Ù‡ Ø±ÙˆÙ†Ø¯ ÙØ¹Ù„ÛŒ', 'Ø§Ù†Ú¯ÛŒØ²Ø´ Ø¨Ø§Ù„Ø§', 'Ø¨Ù‡ÛŒÙ†Ù‡ Ø³Ø§Ø²ÛŒ Ø¬Ø²Ø¦ÛŒ'],
                medium: ['Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…ØªÙˆØ³Ø·', 'Ø¨Ù‡Ø¨ÙˆØ¯ ØªØ¯Ø±ÛŒØ¬ÛŒ', 'Ø§Ù†Ú¯ÛŒØ²Ø´ Ù…ØªÙˆØ³Ø·', 'ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù'],
                low: ['Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¶Ø¹ÛŒÙ', 'Ø§ØµÙ„Ø§Ø­ Ø§Ø³Ø§Ø³ÛŒ', 'Ø§Ù†Ú¯ÛŒØ²Ø´ Ù¾Ø§ÛŒÛŒÙ†', 'Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÛŒØ²ÛŒ Ù…Ø¬Ø¯Ø¯']
            };
            const averageScore = evals.reduce((sum, e) => sum + e.finalScore, 0) / evals.length;
            let level;
            if (averageScore > 75) level = 'high';
            else if (averageScore >= 50) level = 'medium';
            else level = 'low';
            summary = levelAnalyses[level][0];
            strategic = levelAnalyses[level][1];
            psychology = levelAnalyses[level][2];
            solution = levelAnalyses[level][3];
            return { summary, strategic, psychology, solution };
        }

        function generateRecommendations(weaknesses, criteria) {
            let recs = [];
            weaknesses.forEach(w => {
                recs.push(`Ø¨Ù‡Ø¨ÙˆØ¯ ${w}`);
            });
            return recs;
        }

        function generateTrends(evals) {
            let trends = [];
            const sorted = evals.sort((a,b) => new Date(a.savedAt) - new Date(b.savedAt));
            for (let i = 1; i < sorted.length; i++) {
                const diff = sorted[i].finalScore - sorted[i-1].finalScore;
                if (diff > 0) trends.push(`Ø§ÙØ²Ø§ÛŒØ´ ${diff.toFixed(2)} Ø§Ø² ${gregorianToJalali(new Date(sorted[i-1].savedAt))} Ø¨Ù‡ ${gregorianToJalali(new Date(sorted[i].savedAt))}`);
                else if (diff < 0) trends.push(`Ú©Ø§Ù‡Ø´ ${Math.abs(diff).toFixed(2)} Ø§Ø² ${gregorianToJalali(new Date(sorted[i-1].savedAt))} Ø¨Ù‡ ${gregorianToJalali(new Date(sorted[i].savedAt))}`);
            }
            return trends;
        }

        function checkEarlyWarnings(evals, criteria) {
            let warnings = [];
            evals.forEach(e => {
                criteria.forEach(c => {
                    if (c.axis.toLowerCase().includes('safety') && e.scores[c.id] < 2) warnings.push(`Ù‡Ø´Ø¯Ø§Ø± Ø§ÛŒÙ…Ù†ÛŒ Ù¾Ø§ÛŒÛŒÙ† Ø¯Ø± ${e.managerName} (${e.schoolName})`);
                });
                if (Object.values(e.scores).filter(s => s < 2).length > 3) warnings.push(`Ø±ÛŒØ³Ú© Ø¨Ø§Ù„Ø§ Ø¯Ø± ${e.managerName} (${e.schoolName}) - Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ ÙÙˆØ±ÛŒ`);
            });
            return warnings;
        }

        function calculateAxisScore(evalData, criteria, axis) {
            let sum = 0, count = 0;
            criteria.filter(c => c.axis === axis && evalData.enabledCriteria?.includes(c.id)).forEach(c => {
                sum += evalData.scores[c.id] || 0;
                count++;
            });
            return count > 0 ? sum / count : 0;
        }

        function getWeakAxes(evalData, criteria) {
            const axes = [...new Set(criteria.map(c => c.axis))];
            return axes.filter(axis => calculateAxisScore(evalData, criteria, axis) < 2);
        }

        // Ranking
        function loadRankingFilters() {
            getAllFromStore('evaluations').then(evals => {
                const managementSelect = document.getElementById('rankManagementType');
                const courseSelect = document.getElementById('rankCourseType');
                const genderSelect = document.getElementById('rankGender');
                const areaSelect = document.getElementById('rankAreaType');
                managementSelect.innerHTML = '<option value="">Ù†ÙˆØ¹ Ù…Ø¯ÛŒØ±ÛŒØª</option>';
                courseSelect.innerHTML = '<option value="">Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡</option>';
                genderSelect.innerHTML = '<option value="">Ø¬Ù†Ø³ÛŒØª</option>';
                areaSelect.innerHTML = '<option value="">Ù†ÙˆØ¹ Ù…Ù†Ø·Ù‚Ù‡</option>';
                const managementTypes = [...new Set(evals.map(e => e.managementType))];
                managementTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    managementSelect.appendChild(option);
                });
                const courseTypes = ['Ú©ÙˆØ¯Ú©Ø³ØªØ§Ù†', 'Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ', 'Ù…ØªÙˆØ³Ø·Ù‡ Ø§ÙˆÙ„', 'Ù…ØªÙˆØ³Ø·Ù‡ Ø¯ÙˆÙ…', 'Ù‡Ù†Ø±Ø³ØªØ§Ù†', 'Ú©Ø§Ù†ÙˆÙ†', 'Ø¯Ø§Ø±Ø§Ù„Ù‚Ø±Ø¢Ù†', 'Ø§Ø³ØªØ«Ù†Ø§Ø¦Ø§Øª', 'Ù†Ø§Ø­ÛŒÙ‡', 'Ø§Ø³ØªØ§Ù†', 'Ø³Ø§ÛŒØ±'];
                courseTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    courseSelect.appendChild(option);
                });
                const genders = ['Ù¾Ø³Ø±', 'Ø¯Ø®ØªØ±', 'Ù…Ø®ØªÙ„Ø·'];
                genders.forEach(gender => {
                    const option = document.createElement('option');
                    option.value = gender;
                    option.textContent = gender;
                    genderSelect.appendChild(option);
                });
                const areaTypes = [...new Set(evals.map(e => e.areaType))];
                areaTypes.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
            });
        }

        function applyRankingFilters() {
            getAllFromStore('evaluations').then(evals => {
                let filteredEvals = evals;
                const management = document.getElementById('rankManagementType').value;
                const course = document.getElementById('rankCourseType').value;
                const gender = document.getElementById('rankGender').value;
                const area = document.getElementById('rankAreaType').value;
                if (management) filteredEvals = filteredEvals.filter(e => e.managementType === management);
                if (course) filteredEvals = filteredEvals.filter(e => e.courseType === course);
                if (gender) filteredEvals = filteredEvals.filter(e => e.gender === gender);
                if (area) filteredEvals = filteredEvals.filter(e => e.areaType === area);
                filteredEvals.sort((a, b) => b.finalScore - a.finalScore);
                const tbody = document.getElementById('rankingTable').querySelector('tbody');
                tbody.innerHTML = '';
                filteredEvals.forEach(e => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${e.managerName}</td><td>${e.personnelCode}</td><td>${e.schoolName}</td><td>${e.finalScore.toFixed(2)}</td>`;
                    tbody.appendChild(tr);
                });
            });
        }

        function exportRankingToExcel() {
            getAllFromStore('evaluations').then(evals => {
                getAllFromStore('criteria').then(criteria => {
                    let filteredEvals = evals;
                    const management = document.getElementById('rankManagementType').value;
                    const course = document.getElementById('rankCourseType').value;
                    const gender = document.getElementById('rankGender').value;
                    const area = document.getElementById('rankAreaType').value;
                    if (management) filteredEvals = filteredEvals.filter(e => e.managementType === management);
                    if (course) filteredEvals = filteredEvals.filter(e => e.courseType === course);
                    if (gender) filteredEvals = filteredEvals.filter(e => e.gender === gender);
                    if (area) filteredEvals = filteredEvals.filter(e => e.areaType === area);
                    filteredEvals.sort((a, b) => b.finalScore - a.finalScore);
                    const data = filteredEvals.map(e => {
                        const row = {
                            'Ù†Ø§Ù… Ù…Ø¯ÛŒØ±': e.managerName,
                            'Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ': e.personnelCode,
                            'Ù†Ø§Ù… Ù…Ø¯Ø±Ø³Ù‡': e.schoolName,
                            'Ù†ÙˆØ¹ Ù…Ø¯ÛŒØ±ÛŒØª': e.managementType,
                            'Ø¬Ù†Ø³ÛŒØª': e.gender,
                            'Ú©Ø¯ Ù…Ø¯Ø±Ø³Ù‡': e.schoolCode,
                            'Ù†ÙˆØ¹ Ù…Ù†Ø·Ù‚Ù‡': e.areaType,
                            'ØªÙ„ÙÙ†': e.phone,
                            'Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ': e.educationDegree,
                            'Ø³Ù†ÙˆØ§Øª Ø®Ø¯Ù…Øª': e.serviceYears,
                            'Ø³Ù†ÙˆØ§Øª Ù…Ø¯ÛŒØ±ÛŒØª': e.managementYears,
                            'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´ Ø¢Ù…ÙˆØ²Ø§Ù†': e.studentCount,
                            'ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø³Ù†Ù„': e.staffCount,
                            'Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡': e.courseType,
                            'ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø²Ø¯ÛŒØ¯': e.visitDate,
                            'Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ': e.finalScore.toFixed(2),
                            'Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø¯Ø±': gregorianToJalali(new Date(e.savedAt)),
                            'Ù„ÙˆÚ©ÛŒØ´Ù†': e.location,
                            'Ø¹Ú©Ø³': e.photo ? 'Ø¨Ù„Ù‡' : 'Ø®ÛŒØ±',
                            'ØµØ¯Ø§': e.audio ? 'Ø¨Ù„Ù‡' : 'Ø®ÛŒØ±'
                        };
                        criteria.forEach(c => {
                            if (e.scores[c.id]) {
                                row[`Ù†Ù…Ø±Ù‡ ${c.title}`] = e.scores[c.id];
                                row[`ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ${c.title}`] = e.notes[c.id] || '';
                            }
                        });
                        e.companions.forEach((comp, i) => {
                            row[`Ù‡Ù…Ø±Ø§Ù‡ ${i+1} Ù†Ø§Ù…`] = comp.name;
                            row[`Ù‡Ù…Ø±Ø§Ù‡ ${i+1} Ú©Ø¯`] = comp.code;
                            row[`Ù‡Ù…Ø±Ø§Ù‡ ${i+1} Ø§Ù…Ø¶Ø§`] = 'Ø¨Ù„Ù‡';
                        });
                        row['Ø§Ù…Ø¶Ø§ÛŒ Ø¨Ø§Ø²Ø±Ø³'] = 'Ø¨Ù„Ù‡';
                        row['Ø§Ù…Ø¶Ø§ÛŒ Ù…Ø¯ÛŒØ±'] = 'Ø¨Ù„Ù‡';
                        return row;
                    });
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ');
                    XLSX.writeFile(wb, 'ranking.xlsx');
                });
            });
        }

        function printRanking() {
            const content = document.getElementById('rankingTable').outerHTML;
            const printWindow = window.open('', '', 'height=500, width=800');
            printWindow.document.write('<html><head><title>Ù¾Ø±ÛŒÙ†Øª Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ</title>');
            printWindow.document.write('<style>table { border-collapse: collapse; width: 100%; } th, td { border: 1px solid black; padding: 8px; text-align: right; }</style>');
            printWindow.document.write('</head><body >');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        // PDF Table
        function loadPdfTable() {
            getAllFromStore('evaluations').then(evals => {
                const tbody = document.getElementById('pdfTable').querySelector('tbody');
                tbody.innerHTML = '';
                evals.forEach(e => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${e.managerName}</td><td>${e.personnelCode}</td><td>${e.schoolName}</td><td><button onclick="exportPdf(${e.id})">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button></td>`;
                    tbody.appendChild(tr);
                });
            });
        }

        // Reports
        function loadReports() {
            getAllFromStore('evaluations').then(evals => {
                allEvals = evals;
                loadReportFilters();
                applyReportFilterAndSort();
            });
        }

        function loadReportFilters() {
            const genderSelect = document.getElementById('reportGenderFilter');
            const areaSelect = document.getElementById('reportAreaFilter');
            const courseSelect = document.getElementById('reportCourseFilter');
            genderSelect.innerHTML = '<option value="">Ø¬Ù†Ø³ÛŒØª</option>';
            areaSelect.innerHTML = '<option value="">Ù†ÙˆØ¹ Ù…Ù†Ø·Ù‚Ù‡</option>';
            courseSelect.innerHTML = '<option value="">Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡</option>';
            const genders = ['Ù¾Ø³Ø±', 'Ø¯Ø®ØªØ±', 'Ù…Ø®ØªÙ„Ø·'];
            genders.forEach(gender => {
                const option = document.createElement('option');
                option.value = gender;
                option.textContent = gender;
                genderSelect.appendChild(option);
            });
            const areas = [...new Set(allEvals.map(e => e.areaType))];
            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaSelect.appendChild(option);
            });
            const courses = ['Ú©ÙˆØ¯Ú©Ø³ØªØ§Ù†', 'Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ', 'Ù…ØªÙˆØ³Ø·Ù‡ Ø§ÙˆÙ„', 'Ù…ØªÙˆØ³Ø·Ù‡ Ø¯ÙˆÙ…', 'Ù‡Ù†Ø±Ø³ØªØ§Ù†', 'Ú©Ø§Ù†ÙˆÙ†', 'Ø¯Ø§Ø±Ø§Ù„Ù‚Ø±Ø¢Ù†', 'Ø§Ø³ØªØ«Ù†Ø§Ø¦Ø§Øª', 'Ù†Ø§Ø­ÛŒÙ‡', 'Ø§Ø³ØªØ§Ù†', 'Ø³Ø§ÛŒØ±'];
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                courseSelect.appendChild(option);
            });
        }

        function applyReportFilterAndSort() {
            let filteredEvals = allEvals;
            const filter = document.getElementById('reportFilter').value.toLowerCase();
            if (filter) {
                filteredEvals = filteredEvals.filter(e => e.managerName.toLowerCase().includes(filter) || e.personnelCode.includes(filter) || e.schoolName.toLowerCase().includes(filter));
            }
            const gender = document.getElementById('reportGenderFilter').value;
            const area = document.getElementById('reportAreaFilter').value;
            const course = document.getElementById('reportCourseFilter').value;
            if (gender) filteredEvals = filteredEvals.filter(e => e.gender === gender);
            if (area) filteredEvals = filteredEvals.filter(e => e.areaType === area);
            if (course) filteredEvals = filteredEvals.filter(e => e.courseType === course);
            const sort = document.getElementById('reportSort').value;
            if (sort === 'score_desc') filteredEvals.sort((a, b) => b.finalScore - a.finalScore);
            if (sort === 'score_asc') filteredEvals.sort((a, b) => a.finalScore - b.finalScore);
            if (sort === 'management') filteredEvals.sort((a, b) => a.managementType.localeCompare(b.managementType));
            if (sort === 'name_asc') filteredEvals.sort((a, b) => a.managerName.localeCompare(b.managerName));
            if (sort === 'name_desc') filteredEvals.sort((a, b) => b.managerName.localeCompare(a.managerName));
            const tbody = document.getElementById('reportsTable').querySelector('tbody');
            tbody.innerHTML = '';
            filteredEvals.forEach(e => {
                const tr = document.createElement('tr');
                const shamsiDate = gregorianToJalali(new Date(e.savedAt));
                tr.innerHTML = `<td>${e.managerName}</td><td>${e.personnelCode}</td><td>${e.schoolName}</td><td>${e.managementType}</td><td>${e.courseType}</td><td>${e.finalScore.toFixed(2)}</td><td>${shamsiDate}</td>`;
                tbody.appendChild(tr);
            });
        }

        function exportReportsToExcel() {
            getAllFromStore('evaluations').then(evals => {
                getAllFromStore('criteria').then(criteria => {
                    const data = evals.map(e => {
                        const row = {
                            'Ù†Ø§Ù… Ù…Ø¯ÛŒØ±': e.managerName,
                            'Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ': e.personnelCode,
                            'Ù†Ø§Ù… Ù…Ø¯Ø±Ø³Ù‡': e.schoolName,
                            'Ù†ÙˆØ¹ Ù…Ø¯ÛŒØ±ÛŒØª': e.managementType,
                            'Ø¬Ù†Ø³ÛŒØª': e.gender,
                            'Ú©Ø¯ Ù…Ø¯Ø±Ø³Ù‡': e.schoolCode,
                            'Ù†ÙˆØ¹ Ù…Ù†Ø·Ù‚Ù‡': e.areaType,
                            'ØªÙ„ÙÙ†': e.phone,
                            'Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ': e.educationDegree,
                            'Ø³Ù†ÙˆØ§Øª Ø®Ø¯Ù…Øª': e.serviceYears,
                            'Ø³Ù†ÙˆØ§Øª Ù…Ø¯ÛŒØ±ÛŒØª': e.managementYears,
                            'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´ Ø¢Ù…ÙˆØ²Ø§Ù†': e.studentCount,
                            'ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø³Ù†Ù„': e.staffCount,
                            'Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡': e.courseType,
                            'ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø²Ø¯ÛŒØ¯': e.visitDate,
                            'Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ': e.finalScore.toFixed(2),
                            'Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø¯Ø±': gregorianToJalali(new Date(e.savedAt)),
                            'Ù„ÙˆÚ©ÛŒØ´Ù†': e.location,
                            'Ø¹Ú©Ø³': e.photo ? 'Ø¨Ù„Ù‡' : 'Ø®ÛŒØ±',
                            'ØµØ¯Ø§': e.audio ? 'Ø¨Ù„Ù‡' : 'Ø®ÛŒØ±'
                        };
                        criteria.forEach(c => {
                            if (e.scores[c.id]) {
                                row[`Ù†Ù…Ø±Ù‡ ${c.title}`] = e.scores[c.id];
                                row[`ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ${c.title}`] = e.notes[c.id] || '';
                            }
                        });
                        e.companions.forEach((comp, i) => {
                            row[`Ù‡Ù…Ø±Ø§Ù‡ ${i+1} Ù†Ø§Ù…`] = comp.name;
                            row[`Ù‡Ù…Ø±Ø§Ù‡ ${i+1} Ú©Ø¯`] = comp.code;
                            row[`Ù‡Ù…Ø±Ø§Ù‡ ${i+1} Ø§Ù…Ø¶Ø§`] = 'Ø¨Ù„Ù‡';
                        });
                        row['Ø§Ù…Ø¶Ø§ÛŒ Ø¨Ø§Ø²Ø±Ø³'] = 'Ø¨Ù„Ù‡';
                        row['Ø§Ù…Ø¶Ø§ÛŒ Ù…Ø¯ÛŒØ±'] = 'Ø¨Ù„Ù‡';
                        return row;
                    });
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§');
                    XLSX.writeFile(wb, 'reports.xlsx');
                });
            });
        }

        function exportReportsToPdf() {
            const element = document.getElementById('reportsTable');
            const opt = {
                margin: 0.2,
                filename: 'reports.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            html2pdf().from(element).set(opt).save();
        }

        // Smart Search
        function searchTable(tableId, inputId) {
            const input = document.getElementById(inputId).value.toLowerCase();
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(input) ? '' : 'none';
            });
        }

        function gregorianToJalali(date) {
            let g_y = date.getFullYear(), g_m = date.getMonth() + 1, g_d = date.getDate();
            let g_days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            let j_days_in_month = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
            let gy = g_y - 1600;
            let gm = g_m - 1;
            let gd = g_d - 1;
            let g_day_no = 365 * gy + Math.floor((gy + 3) / 4) - Math.floor((gy + 99) / 100) + Math.floor((gy + 399) / 400);
            for (let i = 0; i < gm; ++i) g_day_no += g_days_in_month[i];
            if (gm > 1 && ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0))) ++g_day_no;
            g_day_no += gd;
            let j_day_no = g_day_no - 79;
            let j_np = Math.floor(j_day_no / 12053);
            j_day_no %= 12053;
            let jy = 979 + 33 * j_np + 4 * Math.floor(j_day_no / 1461);
            j_day_no %= 1461;
            if (j_day_no >= 366) {
                jy += Math.floor((j_day_no - 1) / 365);
                j_day_no = (j_day_no - 1) % 365;
            }
            let i = 0;
            for (; i < 11 && j_day_no >= j_days_in_month[i]; ++i) j_day_no -= j_days_in_month[i];
            let jm = i + 1;
            let jd = j_day_no + 1;
            return `${jy}/${jm.toString().padStart(2, '0')}/${jd.toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function loadDashboardStats() {
            getAllFromStore('users').then(users => {
                document.getElementById('userCount').textContent = `ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: ${users.length}`;
            });
            getAllFromStore('evaluations').then(evals => {
                document.getElementById('evalCount').textContent = `ØªØ¹Ø¯Ø§Ø¯ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§: ${evals.length}`;
                if (evals.length > 0) {
                    const avgScore = evals.reduce((sum, e) => sum + e.finalScore, 0) / evals.length;
                    document.getElementById('avgScore').textContent = `Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù†Ù…Ø±Ø§Øª: ${avgScore.toFixed(2)}`;
                    const good = evals.filter(e => e.finalScore > 75).length;
                    const medium = evals.filter(e => e.finalScore >= 50 && e.finalScore <= 75).length;
                    const poor = evals.filter(e => e.finalScore < 50).length;
                    document.getElementById('statusSummary').textContent = `ÙˆØ¶Ø¹ÛŒØª: Ø®ÙˆØ¨ ${good}ØŒ Ù…ØªÙˆØ³Ø· ${medium}ØŒ Ø¶Ø¹ÛŒÙ ${poor}`;
                }
            });
        }

        initDB();
    </script>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyCtFnXwQbwcCjSdeI0Ac2oTH6MykJcY4TU",
    authDomain: "arzyabi-9be0a.firebaseapp.com",
    projectId: "arzyabi-9be0a",
    storageBucket: "arzyabi-9be0a.firebasestorage.app",
    messagingSenderId: "404465689170",
    appId: "1:404465689170:web:589bdb262b2a445ae7f58b",
    measurementId: "G-22F00LXKE9"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
</body>
</html>
